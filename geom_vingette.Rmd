---
title: "Creating New Geom_*() Objects for {ggplot2}"
author: "Ben Stano, Kathryn Cronquist, and Thea De Jong"
date: "3/27/2022"
output: html_document
---

# Extending `{ggplot2}`

# Background

The `{ggplot2}` package is the most common used and robust plotting package in R.

While the tools provided to users are straightforward once learned, extending the functionality of `{ggplot2}` is a different beast entirely. `{ggplot2}` is built on the `ggproto` system of object oriented programming, a system used only in `{ggplot2}`. This OOP system is combined with the `grob` object-type from the `{grid}` package to create the stylish graphs most R users are familiar with.

This vignette will focus on giving readers enough information of the `ggproto` OOP system and `grob` objects to extend `{ggplot2}` functionality, creating graphics customized to the user's needs. For a deeper dive into `ggproto`, `grob` objects, and other `{ggplot2}` topics, use these attached references:

  - [Extending ggplot2](https://ggplot2.tidyverse.org/articles/extending-ggplot2.html)
  - [The grid Package](https://bookdown.org/rdpeng/RProgDA/the-grid-package.html)
  - [grid Graphics](https://stat.ethz.ch/R-manual/R-devel/library/grid/doc/grid.pdf)
  - [Modifying grid Grobs](http://web.mit.edu/r/current/lib/R/library/grid/doc/grobs.pdf)

#### Necessary imports to get started:

```{r}
library(ggplot2)
library(grid)
```

This vignette will specifically focus on creating Stat and Geom type objects to extend `{ggplot2}`. A stat_*() function returns a layer that contains a Stat object, while a geom_*() function returns a layer that contains a Geom object. Stat objects are concerned with applying a particular type of transformation to a dataset, while Geom objects are concerned with graphically displaying given data in a particular way. Though these may seem like very different goals, both are more similar than they appear, as they both are responsible for rendering the data in a plot. These objects are all built on top of the `ggproto` object oriented system. 

Both Stat and Geom objects require a `ggproto` object declaration and a call to the `layer()` function.

## Creating Stat and Geom Objects: the `ggproto()` Function

`ggproto` objects are initialized using the `ggproto` function. At the basic level, they require a name, a character object, and a type to inherit from, which, for our purposes, is either `Stat` or `Geom`.

```{r}
G <- ggproto("G", # the name of the ggproto object
             NULL, # the inheritance type, typically `Stat` or `Geom`
             z = 1,
             double_z = function(self) {
               self$z <- self$z * 2
             }
    )

G$z
G$double_z()
G$double_z()
G$z
```

### The Stat `ggproto`

Stats are `ggproto` objects which must be constructed with at least two arguments:

 - `required_aes`: character vector that list the aesthetics users must provide
 - `compute_group`: a function which returns properly transformed data
 
After these two arguments, a `layer()` function is used to specify defaults and specific parameters for the stat. First, one defines the defaults for the function. Then the `layer()` function is called and sends arguments for the stat to the params argument. The same process is done for Geom objects. However, Stat objects are more concerned with applying specific mathematically transformative logic to data. 

### The Geom `ggproto`

Creating a Geom object is slightly more complicated than creating a new Stat object, as Geom objects require an understanding of `grid graphics` and `grob` objects from `{grid}`.

Geom objects are `ggproto` objects which must be constructed using at least four arguments:

 - `required_aes`: character vector that lists the aesthetics users must provide
 - `default_aes` : list of aesthetics that have default values
 - `draw_key`: provides the function used to draw the key in the legend
 - `draw_panel()`: a function that requires three arguments a returns a `grob` object. `Grob` objects are the base form of graphics from the `{grid}` package, the base R package used in `{ggplot2}` graphics, these will be further explained later in the vignette. `draw_group()` may be used instead if one graphic element per row is required. Both require the same three arguments:
   - `data`: data.frame with one column for each aesthetic
   - `panel_params`: list of per-panel parameters generated by `coord()`
   - `coord`: an object describing a coordinate system

Geom objects are concerned with graphing data in a particular way.

### The `layer()` function

The layer function, regardless of whether one is creating a Stat object or a Geom object, is where the defaults from the function are sent to when calling the function. They specify arguments for the Stat or Geom object as well as any aesthetics. The params argument is perhaps one of the most important, as it can be used to inherit parameters from other functions.

Essential Arguments Used in the Following Examples:

 - `geom`: geometric object used in displaying data
 - `stat`: statistical transformation used on the data
 - `data`: data taking the form of a data.frame, data inherited from plot data in the `ggplot()` call, or a function with the return value of a data.frame
 - `mapping`: mappings created by `aes()` to specify x and y values, for example
 - `position`: position adjustment
 - `show.legend`: determines whether this layer will be included in legends
 - `inherit.aes`: combines default aesthetics if TRUE, overrides them if FALSE
 - `params`: any additional parameters added to geom and stat, such as removing NA values
 
Other arguments include:

 - `check.aes`
 - `check.param`
 - `key_glyph`
 - `layer_class`

Note: While layer can also be called using `geom_` or `stat_`, this may cause some confusion, as a layer necessitates both a Geom and a Stat in its arguments

## The `{grid}` package

`{grid}` is a base R package the provides highly flexible and customizable graphical output. It is not responsible for displaying base graphical functions like `plot()`, but it does come pre-loaded with R.

While `{grid}` does not provide high-level functions for outputting specific plots or graphics, it is the building blocks for many other high-level graphical output functions, such as those found in `{ggplot2}`. Knowledge of `{grid}` is required for creating complex custom `geom` objects.

Working by itself, `{grid}` functions at a comparatively low-level. The basic way to display graphics of any kind in `{grid}` is:
 - initialize and custom `grob` objects as desired
 - call the custom objects with `grid.draw()`
 
### Exploring `grob` objects

`grob` objects are key to extending `{ggplot2}` and creating custom `geom` objects.

`grob` objects are the items that actually get displayed using `{grid}` graphics. A `{grid}` display without a `grob` would result in a blank plot. `{grid}` uses the `*Grob()` family of functions to create of edit `grob` objects. `{grid}` also contains the `grid.*()` family of functions to create their associate `grob` objects, but the `*Grob()` is more useful for our purposes.

All `*Grob()` functions take arguments that change in relation to their graphical output type. However, all `*Grob()` functions take the `gp` argument, which allows for further customization. The `gp` argument takes a `gpar()` function as input.

```{r}
circle <- circleGrob(x = 0.5, y = 0.5, r = 0.25,
                     gp = gpar(col = "red",   # line color
                               fill = "blue", # fill color
                               alpha = 0.75,  # transparency
                               lty = 4,       # line type
                               lwd = 5        # line width
                               )
                     )      

grid.draw(circle)

?pointsGrob
```

`gpar()` takes more arguments than shown, allowing for even more customization.

Here are some of the basic `*Grob` family of functions:
 - `circleGrob()`: as shown previously, this creates a circle
 - `linesGrob()`: create a series of lines
 - `rectGrob()`: create a rectangle
 - `polygonGrob()`: create a polygon, remember the rules of polygons when using this
 - `pointsGrob()`: create data symbols (these may be points, stars, shapes, etc.)
 - `rasterGrob()`: create a bitmap image of a given size, shape, and location
 - `segmentsGrob()`: create line segments
 - `xaxisGrob()`: create an x-axis
 - `yaxisGrob()`: create a y-axis
 - `legendGrob()`: create a legend (this function is still in development and may change)

You can look at the help sections of each `*Grob()` function to learn its required arguments and other information.

The `{gridExtra}` package contains other types of `grob` objects and associated functions, like `tableGrob()`. This package and its associated functions work well with `{grid}` and `{ggplot2}`, so feel free to use this as liberally as you'd like!

### Viewports

Viewports control how `{grid}` objects are displayed. They are necessary when display base `{grid}` graphics, but can sometimes be ignored when extending `{ggplot2}` graphics.

### Coordinate Systems

Placeholder text

# Stat and Geom Object Examples

## Example: The Stat `ggproto`

In this Stat example, we first create the Stat object, `StatPercentile`, and then the layer function, `stat_percentile`. Finally, we test out the Stat on the `mpg` dataset to create a plot.   

```{r}
StatPercentile <- ggproto("StatPercentile", Stat,
                          
  compute_group = function(data, scales) {
    data <- data.frame(y = data$y)
    new_data <- data.frame(y = apply(data, 2, function(x) ecdf(x)(sort(x))))
    new_data$x <- 1:nrow(new_data)
    new_data
  },
  
  required_aes = c("y")
  
)

stat_percentile <- function(mapping = NULL, data = NULL, geom = "line",
                       position = "identity", na.rm = FALSE, show.legend = NA, 
                       inherit.aes = TRUE) {
  layer(
    stat = StatPercentile, data = data, mapping = mapping, geom = geom, 
    position = position, show.legend = show.legend, inherit.aes = inherit.aes,
    params = list(na.rm = na.rm)
  )
}

ggplot(mpg, aes(y = hwy)) +
  stat_percentile()
```

## Allowing for Additional User Arguments

Building off of the previous example, we can add additional user arguments to improve the plot. For example, below we add color and linetype to the previous stat percentile plot. 

```{r}
StatPercentile <- ggproto("StatPercentile", Stat,
                          
  compute_group = function(data, scales) {
    data <- data.frame(y = data$y)
    new_data <- data.frame(y = apply(data, 2, function(x) ecdf(x)(sort(x))))
    new_data$x <- 1:nrow(new_data)
    new_data
  },
  
  required_aes = c("y")
  
)

stat_percentile <- function(mapping = NULL, data = NULL, geom = "line",
                       position = "identity", na.rm = FALSE, show.legend = NA, 
                       inherit.aes = TRUE, ...) {
  layer(
    stat = StatPercentile, data = data, mapping = mapping, geom = geom, 
    position = position, show.legend = show.legend, inherit.aes = inherit.aes,
    params = list(na.rm = na.rm, ...)
  )
}

ggplot(mpg, aes(y = hwy)) +
  stat_percentile(color = "red", linetype = "longdash")
```

## Example: The Geom `ggproto`

In this Geom example, we first create the Geom object, `GeomSimpleLine`, and then the layer function, `geom_simple_line`. Finally, we test out the Geom on the `mtcars` dataset to create a simple line plot.  

```{r}
GeomSimpleLine <- ggproto("GeomSimpleLine", Geom,
  required_aes = c("x", "y"),
  default_aes = aes(shape = 19, colour = "black"),
  draw_key = draw_key_path,

  draw_panel = function(data, panel_params, coord) {
    
    data <- dplyr::arrange(data, x)
    
    coords <- coord$transform(data, panel_params)
    grid::linesGrob(
      x = unit(coords$x, "npc"), 
      y = unit(coords$y, "npc"),
      gp = grid::gpar(col = coords$colour)
    )
  }
)

geom_simple_line <- function(mapping = NULL, data = NULL, stat = "identity",
                              position = "identity", na.rm = FALSE, show.legend = NA, 
                              inherit.aes = TRUE, ...) {
  layer(
    geom = GeomSimpleLine, mapping = mapping,  data = data, stat = stat, 
    position = position, show.legend = show.legend, inherit.aes = inherit.aes,
    params = list(na.rm = na.rm, ...)
  )
}

ggplot(mtcars, aes(mpg, wt)) +
  geom_simple_line(color="blue")
```

# Extending `{ggplot2}`: Difference Plot

The following examples walk through the creation of a custom Stat object, a custom Geom object, and how the two work together to extend `{ggplot2}` and create a custom difference plot. 

A difference plot shows the average of two methods on the `x axis` and the difference between the two methods on the `y axis`.

## Custom Stat for Difference Plot

```{r}
StatDifference <- ggproto("StatDifference", Stat,
  compute_group = function(data, scales) {
    method1 <- (data$x + data$y)/2
    method2 <- data$x - data$y
    new_data <- data.frame(x = method1,
                           y = method2)
    new_data
  },
  
  required_aes = c("x", "y")
)
```

## Custom Geom for Difference Plot

```{r}
GeomSimpleDifference <- ggproto("GeomSimpleDifference", Geom,
  required_aes = c("x", "y"),
  default_aes = aes(shape = 20, color = "black"),
  draw_key = draw_key_point,
  
  draw_panel = function(data, panel_params, coord) {
    coords <- coord$transform(data, panel_params)
    gList(grid::pointsGrob(
      coords$x, coords$y,
      pch = coords$shape,
      gp = grid::gpar(col = coords$colour)
    ),
    grid::linesGrob(
      coords$x, mean(coords$y),
      gp = grid::gpar(col = coords$colour)
    ))
  }
  
)

geom_simple_diff <- function(mapping = NULL, data = NULL, stat = "difference",
                              position = "identity", na.rm = FALSE, show.legend = NA, 
                              inherit.aes = TRUE) {
  layer(
    geom = GeomSimpleDifference, mapping = mapping,  data = data, stat = stat, 
    position = position, show.legend = show.legend, inherit.aes = inherit.aes,
    params = list(na.rm = na.rm)
  )
}
```

## Plotting the Difference Plot

```{r}
set.seed(1)
data <- data.frame(x = runif(100, 0, 10),
                   y = runif(100, 0, 10))


ggplot(data, aes(x, y)) +
  geom_simple_diff()
```


# Exercises

1. Create a Stat for a Regression Line (`geom_smooth()`)

```{r, echo = FALSE}
StatLm <- ggproto("StatLm", Stat,
                          
  compute_group = function(data, scales) {
    rng <- range(data$x, na.rm = TRUE)
    new_data <- data.frame(x = seq(rng[1], rng[2], length.out = nrow(data)))
    
    model <- lm(y ~ x, data = data)
    
    new_data$y <- predict(model, newdata = data.frame(x = new_data$x))
    new_data
  },
  
  required_aes = c("x", "y")
  
)

stat_lm <- function(mapping = NULL, data = NULL, geom = "line",
                       position = "identity", na.rm = FALSE, show.legend = NA, 
                       inherit.aes = TRUE) {
  layer(
    stat = StatLm, data = data, mapping = mapping, geom = geom, 
    position = position, show.legend = show.legend, inherit.aes = inherit.aes,
    params = list(na.rm = na.rm)
  )
}
```

 - Try it out on this code to achieve the plot below:

```{r}
ggplot(mtcars, aes(x = wt, y = mpg)) +
  geom_point() +
  stat_lm()
```


2. Add arguments to the Regression Line Stat

```{r, echo = FALSE}
StatLm <- ggproto("StatLm", Stat,
                          
  compute_group = function(data, scales, formula = y ~ x) {
    rng <- range(data$x, na.rm = TRUE)
    new_data <- data.frame(x = seq(rng[1], rng[2], length.out = nrow(data)))
    
    model <- lm(formula, data = data)
    
    new_data$y <- predict(model, newdata = data.frame(x = new_data$x))
    new_data
  },
  
  required_aes = c("x", "y")
  
)

stat_lm <- function(mapping = NULL, data = NULL, geom = "line",
                       position = "identity", na.rm = FALSE, show.legend = NA, 
                       inherit.aes = TRUE, ...) {
  layer(
    stat = StatLm, data = data, mapping = mapping, geom = geom, 
    position = position, show.legend = show.legend, inherit.aes = inherit.aes,
    params = list(na.rm = na.rm, ...)
  )
}
```

 - For example, see the plot below:

```{r, echo = FALSE}
ggplot(mtcars, aes(x = wt, y = mpg)) +
  geom_point() +
  stat_lm(formula = y ~ poly(x, 4), color = "blue", linetype = "dotted", size = 3)
```







