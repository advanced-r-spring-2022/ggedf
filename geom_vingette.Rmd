---
title: "Creating New Geom_*() Objects for {ggplot2}"
author: "Ben Stano"
date: "3/27/2022"
output: html_document
---

# Extending `{ggplot2}`

# Imports (move?)

```{r}
library(ggplot2)
library(grid)
```

# Background

The `{ggplot2}` package is the most common used and robust plotting package in R.

While the tools provided to users are straightforward once learned, extending the functionality of `{ggplot2}` is a different beast entirely. `{ggplot2}` is built on the `ggproto` system of object oriented programming, a system used only in `{ggplot2}`. This OOP system is combined with the `grob` object-type from the `{grid}` package to create the stylish graphs most R users are familiar with.

This vignette will focus on given readers enough information of the `ggproto` OOP system and `grob` objects to extend `{ggplot2}` functionality, creating graphics customized to the user's needs. For a deeper dive into `ggproto`, `grob` objects, and other `{ggplot2}` topics, use this attached references:
 - `ggproto` reference
 - `{grid}`/`grob` reference
 - `{ggplot2}` reference
 - other references?

All geom and stat type objects in `{ggplot2}` are build on top of the `ggproto` object oriented system.

Stats are concerned with applying a particular type of transformation to a dataset, while Geoms are concerned with graphically displaying given data in a particular way. Though these may seem like very different goals, both are more similar than they appear.

Both require a `ggproto` object declaration and a call to the `layer()` function.

## Creating Stats and Geoms: the `ggproto()` Function

`ggproto` objects are initialized using the `ggproto` function. At the basic level, they require a name, a character object, and a type to inherit from, for our purposed either `Stat` or `Geom`.

```{r}
G <- ggproto("G", # the name of the ggproto object
             NULL, # the inheritance type, typically `Stat` or `Geom`
             z = 1,
             double_z = function(self) {
               self$z <- self$z * 2
             }
    )

G$z
G$double_z()
G$double_z()
G$z
```

### The Stat `ggproto`

Stats are `ggproto` objects which must be constructed with at least these two arguments:

 - `required_aes`: character vector that list the aesthetics users must provide
 - `compute_group`: a function which returns properly transformed data
 
Stats are more concerned with applying specific mathematically transformative logic to data.

### The Geom `ggproto`

Creating Geoms is slightly more complicated than creating new Stats, as Geoms require an understanding of `{grid}` and `grob` objects from `{grid}`.

Geoms are `ggproto` objects which must be constructed using at least these four arguments:

 - `required_aes`: character vector that lists the aesthetics users must provide
 - `default_aes` : list of aesthetics that have default values
 - `draw_key`: provides the function used to draw the key in the legend
 - `draw_panel()`: a function that requires three arguments a returns a grid glob type object. `draw_group()` may be used instead if one graphic element per row is required. Both require the same three arguments:
   - `data`: data.frame with one column for each aesthetic
   - `panel_params`: list of per-panel parameters generated by `coord()`
   - `coord`: an object describing a coordinate system

Geoms are concerned with graphing data in a particular way.

### The `layer()` function

 - `layer()` function

# Examples

## Stat Example

```{r}
StatPercentile <- ggproto("StatPercentile", Stat,
                          
  compute_group = function(data, scales) {
    data <- data.frame(y = data$y)
    new_data <- data.frame(y = apply(data, 2, function(x) ecdf(x)(sort(x))))
    new_data$x <- 1:nrow(new_data)
    new_data
  },
  
  required_aes = c("y")
  
)

stat_percentile <- function(mapping = NULL, data = NULL, geom = "line",
                       position = "identity", na.rm = FALSE, show.legend = NA, 
                       inherit.aes = TRUE) {
  layer(
    stat = StatPercentile, data = data, mapping = mapping, geom = geom, 
    position = position, show.legend = show.legend, inherit.aes = inherit.aes,
    params = list(na.rm = na.rm)
  )
}

ggplot(mpg, aes(y = hwy)) +
  stat_percentile()
```


## Geom Example

```{r}
GeomSimpleLine <- ggproto("GeomSimpleLine", Geom,
  required_aes = c("x", "y"),
  default_aes = aes(shape = 19, colour = "black"),
  draw_key = draw_key_path,

  draw_panel = function(data, panel_params, coord) {
    coords <- coord$transform(data, panel_params)
    grid::linesGrob(
      x = unit(coords$x, "npc"), 
      y = unit(coords$y, "npc"),
      gp = grid::gpar(col = coords$colour)
    )
  }
)

geom_simple_line <- function(mapping = NULL, data = NULL, stat = "identity",
                              position = "identity", na.rm = FALSE, show.legend = NA, 
                              inherit.aes = TRUE, ...) {
  layer(
    geom = GeomSimpleLine, mapping = mapping,  data = data, stat = stat, 
    position = position, show.legend = show.legend, inherit.aes = inherit.aes,
    params = list(na.rm = na.rm, ...)
  )
}

data <- data.frame(x = 1:10,
                   y = c(1,2,4,7,6,3,1,5,9,8)
)

ggplot(data, aes(x, y)) + 
  geom_simple_line()
```

# Extending `{ggplot2}`: Difference Plot

## Custom Stat for Difference Plot

```{r}
StatDifference <- ggproto("StatDifference", Stat,
  compute_group = function(data, scales) {
    method1 <- (data$x + data$y)/2
    method2 <- data$x - data$y
    new_data <- data.frame(x = method1,
                           y = method2)
    new_data
  },
  
  required_aes = c("x", "y")
)
```

## Custom Geom for Difference Plot

```{r}
GeomSimpleDifference <- ggproto("GeomSimpleDifference", Geom,
  required_aes = c("x", "y"),
  default_aes = aes(shape = 20, color = "black"),
  draw_key = draw_key_point,
  
  draw_panel = function(data, panel_params, coord) {
    coords <- coord$transform(data, panel_params)
    gList(grid::pointsGrob(
      coords$x, coords$y,
      pch = coords$shape,
      gp = grid::gpar(col = coords$colour)
    ),
    grid::linesGrob(
      coords$x, mean(coords$y),
      gp = grid::gpar(col = coords$colour)
    ))
  }
  
)

geom_simple_diff <- function(mapping = NULL, data = NULL, stat = "difference",
                              position = "identity", na.rm = FALSE, show.legend = NA, 
                              inherit.aes = TRUE, ...) {
  layer(
    geom = GeomSimpleDifference, mapping = mapping,  data = data, stat = stat, 
    position = position, show.legend = show.legend, inherit.aes = inherit.aes,
    params = list(na.rm = na.rm, ...)
  )
}
```

## Plotting the Difference Plot

```{r}
set.seed(1)
data <- data.frame(x = runif(100, 0, 10),
                   y = runif(100, 0, 10))


ggplot(data, aes(x, y)) +
  geom_simple_diff()
```

# Extending `{ggplot2}`: Mountain Plot

```{r}
geom_density

StatDensity
```

# Exercises














