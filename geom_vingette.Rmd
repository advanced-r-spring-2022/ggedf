---
title: "Creating New Geom_*() Objects for {ggplot2}"
author: "Ben Stano"
date: "3/27/2022"
output: html_document
---

# Imports (move?)

```{r}
library(ggplot2)
library(grid)
```

# Background

All geoms and stat objects in `{ggplot2}` are build on top of the `ggproto` object oriented system.

`ggproto` needs 4 arguments to build a new geom

 - `required_aes`: character vector that lists the aesthetics users must provide
 - `default_aes` : list of aesthetics that have default values
 - `draw_key`: provides the function used to draw the key in the legend
 - `draw_panel()`: a function that requires three arguments a returns a grid glob type object. `draw_group()` may be used instead if one graphic element per row is required. Both require the same three arguments:
   - `data`: data.frame with one column for each aesthetic
   - `panel_params`: list of per-panel parameters generated by `coord()`
   - `coord`: an object describing a coordinate system

Explanation of the function that builds geoms

 - `layer()` function
 
 Should we explain stat objects? How much?

# Example

```{r}
# this is taken driectly for example vignette
# probably change to another simple geom type (hist, etc.)
GeomSimplePoint <- ggproto("GeomSimplePoint", Geom,
  required_aes = c("x", "y"),
  default_aes = aes(shape = 19, colour = "black"),
  draw_key = draw_key_point,

  draw_panel = function(data, panel_params, coord) {
    coords <- coord$transform(data, panel_params)
    grid::pointsGrob(
      coords$x, coords$y,
      pch = coords$shape,
      gp = grid::gpar(col = coords$colour)
    )
  }
)

geom_simple_point <- function(mapping = NULL, data = NULL, stat = "identity",
                              position = "identity", na.rm = FALSE, show.legend = NA, 
                              inherit.aes = TRUE, ...) {
  layer(
    geom = GeomSimplePoint, mapping = mapping,  data = data, stat = stat, 
    position = position, show.legend = show.legend, inherit.aes = inherit.aes,
    params = list(na.rm = na.rm, ...)
  )
}

ggplot(mpg, aes(displ, hwy)) + 
  geom_simple_point()
```


# Geom for Mountain/Difference/Whateva

```{r}
GeomSimpleDifference <- ggproto("GeomSimpleDifference", Geom,
  required_aes = c("x", "y"),
  default_aes = aes(shape = 20, color = "black"),
  draw_key = draw_key_point,
  
  draw_panel = function(data, panel_params, coord) {
    coords <- coord$transform(data, panel_params)
    grid::pointsGrob(
      coords$x, coords$y,
      pch = coords$shape,
      gp = grid::gpar(col = coords$colour)
    )
  }
)

geom_simple_diff <- function(mapping = NULL, data = NULL, stat = "identity",
                              position = "identity", na.rm = FALSE, show.legend = NA, 
                              inherit.aes = TRUE, ...) {
  layer(
    geom = GeomSimpleDifference, mapping = mapping,  data = data, stat = stat, 
    position = position, show.legend = show.legend, inherit.aes = inherit.aes,
    params = list(na.rm = na.rm, ...)
  )
}

set.seed(1)
data <- data.frame(x = runif(100, 0, 10),
                   y = runif(100, 0, 10))

ggplot(data, aes(x, y)) + 
  geom_simple_diff()
```

```{r}
GeomSimpleDifference <- ggproto("GeomSimpleDifference", Geom,
  required_aes = c("x", "y"),
  default_aes = aes(shape = 20, color = "black"),
  draw_key = draw_key_point,
  
  draw_panel = function(data, panel_params, coord) {
    new_data = data
    new_data$y <- data$x - data$y
    coords <- coord$transform(new_data, panel_params)
    grid::pointsGrob(
      coords$x, coords$y,
      pch = coords$shape,
      gp = grid::gpar(col = coords$colour)
    )
  }
)

geom_simple_diff <- function(mapping = NULL, data = NULL, stat = "identity",
                              position = "identity", na.rm = FALSE, show.legend = NA, 
                              inherit.aes = TRUE, ...) {
  layer(
    geom = GeomSimpleDifference, mapping = mapping,  data = data, stat = stat, 
    position = position, show.legend = show.legend, inherit.aes = inherit.aes,
    params = list(na.rm = na.rm, ...)
  )
}

set.seed(1)
data <- data.frame(x = runif(100, 0, 10),
                   y = runif(100, 0, 10))

ggplot(data, aes(x, y)) + 
  geom_simple_diff() +
  scale_y_continuous(limits = c(-10,10))

?scale_y_continuous
```

```{r}
?pointsGrob
```


```{r}
StatIdentity
```















